# Contents
1. [**Erosion modeling**](#erosion-modeling)
    1. [RULSE](#rusle)
    2. [USPED](#usped)
    3. [SIMWE](#simwe)
      1. [Shallow water flow](#shallow-water-flow)
      2. [Shallow water flow with landcover](#shallow-water-flow-with-landcover)
      3. [Erosion-deposition](#erosion-deposition)
      4. [Sediment flow](#sediment-flow)
      5. [Water flow animation](#water-flow-animation)
2. [**Landscape evolution**](#landscape-evolution)
    1. [RULSE evolution model](#rusle-model)
    2. [USPED evolution model](#usped-model)
    3. [SIMWE evolution model](#simwe-model)
      1. [Erosion-deposition regime](#erosion-deposition-regime)
      2. [Detachment limited regime](#detachment-limited-regime)
      3. [Transport limited regime](#transport-limited-regime)
    4. [Parallel processing](#parallel-processing)
    5. [Travel time](#travel-time)
    6. [Animation](#animation)

---

# Erosion modeling
In this section you will learn about
the RUSLE, USPED, and SIMWE erosion models
in [GRASS GIS](https://grass.osgeo.org/).


Start GRASS GIS in the `nc_spm_evolution` location
and create an `erosion` mapset.

Set your region to our study area with 1 meter resolution
using the module
[g.region](https://grass.osgeo.org/grass74/manuals/g.region.html).
Optionally set the watershed as a mask using the modules
[r.mask](https://grass.osgeo.org/grass74/manuals/r.mask.html).
```
g.region region=region res=1
r.mask vector=watershed
```

---

## RUSLE
The **Revised Universal Soil Loss Equation for Complex Terrain (RUSLE3D)**
is an empirical equation for computing erosion
in a detachment-capacity limited soil erosion regime
for watersheds with complex topography ([Mitasova 1996](https://doi.org/10.1080/02693799608902101)).
It is based on the Universal Soil Loss Equation (USLE),
an empirical equation for estimating the average
sheet and rill soil erosion from rainfall and runoff
on agricultural fields and rangelands with simple topography.
It models erosion dominated regimes without deposition
in which sediment transport capacity
is uniformly greater than detachment capacity.
As an empirical equation the predicted soil loss
is spatially and temporally averaged.
In USLE soil loss per unit area is determined by
an erosivity factor **R**,
a soil erodibility factor **K**,
a slope length factor **L**,
a slope steepness factor **S**,
a cover management factor **C**,
and a prevention measures factor **P**.
These factors are empirical constants derived
from an extensive collection of measurements
on 22.1m standard plots with an average slope of 0.09 degrees.  
RUSLE3D was designed to account for more complex, 3D topography
with converging and diverging flows.
In RUSLE3D the topographic potential for erosion at any given point
is represented by a 3D topographic factor **LS3D**,
which is a function of the upslope contributing area
(i.e. the flow accumulation)
and the angle of the slope.
Sediment flow is approximated with the following equation:
```
E = R * K * LS3D * C * P

where:

E is the average annual soil loss
R is an erosivity factor
K is a soil erodibility factor
LS3D is a dimensionless topographic (length-slope) factor
C is a dimensionless land cover factor
P is a dimensionless prevention measures factor
```

---

**LS3D Factor**
The dimensionless 3D topographic factor LS3D
is a function of
the flow accumulation,
representing the upslope contributing area,
and the slope.
The empirical coefficients *m* and *n*
for the upslope contributing area
and the slope
can range from `0.2` to `0.6`
and `1.0` to `1.3` respectively
with low values representing dominant sheet flow
and high values representing dominant rill flow.
For the study landscape set `m=0.4` and `n=1.3`.
The equation for computing the LS3D-factor is:
```
LS_3D(x,y) = (m+1.0) * (a(x,y) * a_0^-1)^m * (sin(beta) * beta_0^-1)^n

where:

LS_3D is the dimensionless topographic (length-slope) factor
a is flow accumulation (m)
a_0 is the length of the standard USLE plot (22.1 m)
beta is the slope angle (degrees)
m is an empirical coefficient
n is an empirical coefficient
beta_0 is the slope of the standard USLE plot (5.14 degrees)
```

Compute the angle of the slope with the module
[r.slope.aspect](https://grass.osgeo.org/grass74/manuals/r.slope.aspect.html).
Then grow border to fix edge effects of moving window computations
with the module
[r.grow.distance](https://grass.osgeo.org/grass74/manuals/r.grow.distance.html)
and the raster calculator
[r.mapcalc](https://grass.osgeo.org/grass74/manuals/r.mapcalc.html).
Remove the temporary map generated by r.grow.distance with
[g.remove](https://grass.osgeo.org/grass74/manuals/g.remove).
Compute flow accumulation with
[r.watershed](https://grass.osgeo.org/grass74/manuals/r.watershed)
with the `a` flag for positive flow accumulation.
Finally compute the dimensionless 3D topographic factor LS3D
with the raster calculator
[r.mapcalc](https://grass.osgeo.org/grass74/manuals/r.mapcalc.html)
as a function of slope and flow accumulation.
Then use the module
[r.colors](https://grass.osgeo.org/grass74/manuals/r.colors.html)
to assign a sequential, perceptually uniform color table such as viridis
with either histogram equalization or logarithmic scaling
with `e` or `g` flag.
```
r.slope.aspect elevation=elevation_2016 slope=slope_2016
r.grow.distance input=slope_2016 value=grow_slope
r.mapcalc "slope_2016 = grow_slope" --overwrite
g.remove -f type=raster name=grow_slope
r.watershed elevation=elevation_2016 accumulation=accumulation_2016 -a
r.mapcalc "ls_factor=(0.4+1.0)*((accumulation_2016/22.1)^0.4)*((sin(slope_2016)/5.14)^1.3)"
r.colors map=ls_factor color=viridis -e
```

<p align="center"><img src="images/erosion/flow_accumulation_2016.png"></p>

**Flow accumulation**

<p align="center"><img src="images/erosion/ls_factor.png"></p>

**LS3D factor**

---

**Sediment flow**
The R-factor for our study landscape in Fort Bragg will be 310
([Fogleman 2009](http://www.geomodeler.com/Documents/bragg_Main_optimized.pdf)
and [Renard et al. 1997](https://www.ars.usda.gov/ARSUserFiles/64080530/rusle/ah_703.pdf)).
Use the raster calculator
[r.mapcalc](https://grass.osgeo.org/grass74/manuals/r.mapcalc.html)
to create a raster named `r_factor`
with a constant floating point value of 310.0.
The K-factor is derived from the soil map
and the C-factor is derived from the landcover map.
Do not use a P-factor for the study landscape.
Compute flow using the equation `E = R * K * LS3D * C` without the P-factor.
Then convert sediment flow from tons/ha to kg/ms using the equation
`E = E * ton_to_kg / ha_to_m^2`.
Finally use the module
[r.colors](https://grass.osgeo.org/grass74/manuals/r.colors.html)
to set the viridis color table
with the `e` flag for histogram equalization..

```
r.mapcalc "r_factor=310.0"
r.mapcalc "sediment_flow_2016=r_factor*k_factor*ls_factor*c_factor"
r.mapcalc "converted_flow=sediment_flow_2016*1000./10000."
g.rename raster=converted_flow,sediment_flow_2016
r.colors map=sediment_flow color=viridis -e
g.remove -f type=raster name=r_factor
```

<p align="center"><img src="images/erosion/sediment_flow_2016.png"></p>

**Sediment flow**

---

**References**
* Fogleman, Brent D. 2009. “Erosion Modeling: Use of Multiple-Return and Bare-Earth LIDAR Data to Identify Bare Areas Susceptible to Erosion MacRidge, Training Area J, Fort Bragg, NC.” http://www.geomodeler.com/Documents/bragg_Main_optimized.pdf.
* Mitasova, Helena, Jaroslav Hofierka, Maros Zlocha, and Louis R. Iverson. 1996. “Modelling Topographic Potential for Erosion and Deposition Using GIS.” International Journal of Geographical Information Science 10 (5): 629–41. https://doi.org/10.1080/02693799608902101.
* Renard, K. G., G. R. Foster, G. A. Weesies, D. K. McCool, and D. C. Yoder. 1997. “Predicting Soil Erosion by Water: A Guide to Conservation Planning with the Revised Universal Soil Loss Equation (RUSLE).” Washington, DC. https://www.ars.usda.gov/ARSUserFiles/64080530/rusle/ah_703.pdf.

---

## USPED
*Under development*

---

## SIMWE
The processed based Simulation of Water Erosion (SIMWE) model
simulates overland hydrologic and sediment flows using a path sampling method.

**References**
* Mitasova, H, M. Barton, I. Ullah, J. Hofierka, and R.S. Harmon. 2013. “3.9 GIS-Based Soil Erosion Modeling.” In Treatise on Geomorphology, 228–58. https://doi.org/10.1016/B978-0-12-374739-6.00052-X.

---

### Shallow water flow
Compute the partial derivatives of the topography using the module
[r.slope.aspect](https://grass.osgeo.org/grass74/manuals/r.slope.aspect.html).
```
r.slope.aspect elevation=elevation_2016 dx=dx dy=dy
```

Simulate shallow overland water flow with
[r.sim.water](https://grass.osgeo.org/grass74/manuals/r.sim.water.html).
for a 10 minute rain event
with a rainfall intensity of 50 mm/hr.
Walkers are the simulated particles of water in the computation.
Increasing the number of walkers reduces errors,
but increases computation time.
Start with a relatively low number of walkers like 10,000
and increase the number to 1,000,000 for your final simulation.
```
r.sim.water elevation=elevation_2016 dx=dx dy=dy rain_value=50.0 depth=depth nwalkers=10000 niterations=10
```

To see only the concentrated water flow
hide the cells with water depth less than value like `0.03` meters
by either
double clicking on the `depth` map in the layer manager
and setting the list of values to display to `100-0.03`
or running the command:
```
d.rast map=depth values=100-0.03
```
Experiment to find the right minimum value.

In the layer manager move the vector contour map above the depth map
and move the raster elevation or the shaded relief map below the depth map
to better visualize the relationship between topography and water.

Display the legend for the water depth map with either the
`Add raster legend` button
or
the command [d.legend](https://grass.osgeo.org/grass74/manuals/d.legend.html).
Optionally use the range parameter set to `range=100-0.03`
to show only the concentrated flow values.

---

## Shallow water flow with landcover
The first run of the simulation assumed constant landcover
with no infiltration and a constant surface roughness
with a default mannings n value of 0.1.
To study the landcover for our region
add the latest orthophotograph `naip_2014` and
the landcover, mannings, and infiltration maps
to your map display.
Display their legends with either the
`Add raster legend` button
or
the command [d.legend](https://grass.osgeo.org/grass74/manuals/d.legend.html).
Use the `-n` flag to hide categories
that are not represented in the data.
See the [Image classification](#image-classification) section
to learn how to derive these maps from orthophotography.

Now simulate overland water flow with
spatially variable surface roughness and infiltration.
Set `man=mannings` and `infil=infiltration`.
Make sure to set the `--overwrite` flag
because you are rerunning the simulation.
```
r.sim.water elevation=elevation_2016 dx=dx dy=dy rain_value=50.0 man=mannings infil=infiltration depth=depth_2016 nwalkers=10000 niterations=10 --overwrite
```

<p align="center"><img src="images/erosion/depth_2016.png"></p>

**Water depth**

---

## Erosion-deposition
To simulate erosion-deposition you first need to compute
the detachment coefficient, transport coefficient, and shear stress.
Use map algebra with
[r.mapcalc](https://grass.osgeo.org/grass74/manuals/r.mapcalc.html)
to create new maps with constant values for these parameters.
```
r.mapcalc "detachment = 0.001"
r.mapcalc "transport = 0.001"
r.mapcalc "shear_stress = 0.0"
```

Simulate net erosion-deposition (kg/m^2^s) with
[r.sim.sediment](https://grass.osgeo.org/grass74/manuals/r.sim.sediment.html).
```
r.sim.sediment elevation=elevation_2016 water_depth=depth_2016 dx=dx dy=dy detachment_coeff=detachment transport_coeff=transport shear_stress=shear_stress man=mannings erosion_deposition=erosion_deposition_2016 nwalkers=10000
```
Display the legend for the erosion-deposition map with either the
`Add raster legend` button
or
the command [d.legend](https://grass.osgeo.org/grass74/manuals/d.legend.html).

<p align="center"><img src="images/erosion/erosion_deposition_2016.png"></p>

**Erosion deposition**

---

## Sediment flow
In a detachment limited soil erosion regime
water can transport an infinite amount of sediment.
Therefore there is no deposition, only erosion.
In this regime erosion is only limited
by the water flow's capacity to detach sediment.

Overwrite the detachment and transport coefficients
with [r.mapcalc](https://grass.osgeo.org/grass74/manuals/r.mapcalc.html)
```
r.mapcalc "detachment = 0.0001" --overwrite
r.mapcalc "transport = 0.01" --overwrite
```

Simulate sediment flow (kg/ms)
in a detachment limited soil erosion regime with
[r.sim.sediment](https://grass.osgeo.org/grass74/manuals/r.sim.sediment.html).
```
r.sim.sediment elevation=elevation_2016 water_depth=depth_2016 dx=dx dy=dy detachment_coeff=detachment transport_coeff=transport shear_stress=shear_stress man=mannings sediment_flux=sediment_flux_2016 nwalkers=10000
```

<p align="center"><img src="images/erosion/sediment_flux_2016.png"></p>

**Sediment flux**

---

## Water flow animation
To create a water flow animation first run the module
[r.sim.water](https://grass.osgeo.org/grass74/manuals/r.sim.water.html)
with the parameter `output_step=1` and the flag `-t` to
create a time series of water depth rasters.
With these settings this will output a water depth raster map
for each minute of the simulation labelled
`depth.01` through `depth.10`.
```
r.sim.water elevation=elevation_2016 dx=dx dy=dy rain_value=50.0 man=mannings infil=infiltration depth=depth nwalkers=10000 niterations=10 output_step=1 -t
```

List this time series of rasters with the module
[g.list](https://grass.osgeo.org/grass74/manuals/g.list.html).
Use the wildcard notation `*` to list all raster maps
with `depth.` in their names.
Use the flag `-m` to include the mapset names in the output.
Copy the list of maps from the output console.
```
g.list type=raster pattern=depth.* separator=comma -m
```

Launch the animation tool
[g.gui.animation](https://grass.osgeo.org/grass74/manuals/g.gui.animation.html)
and paste the list of depth maps into the raster parameter.
```
g.gui.animation raster=depth.01,depth.02,depth.03,depth.04,depth.05,depth.06,depth.07,depth.08,depth.09,depth.10
```

<p align="center">
  <img src="images/erosion/water-flow.gif" height="250">
  <img src="images/erosion/water-flow-3d.gif" height="250">
</p>

---

# Landscape evolution

In this section you will learn about
the *r.sim.terrain* landscape evolution model
for [GRASS GIS](https://grass.osgeo.org/).
It uses the RUSLE3D, USPED, and SIMWE erosion models
to simulate short-term topographic change
caused by shallow, overland water and sediment flows.

Start GRASS GIS in the `nc_spm_evolution` location
and select the `PERMANENT` mapset.
Install the add-on module *r.sim.terrain*
with [g.extension](https://grass.osgeo.org/grass74/manuals/g.extension.html)
using the url for this repository.
Launch from the Command Line Interface (CLI) with the `ui` flag.
To install the stable release from the GRASS GIS add-ons repository use:
```
g.extension extension=r.sim.terrain
r.sim.terrain --ui
```
To install the development release from this GitHub repository use:
```
g.extension extension=r.sim.terrain url=github.com/baharmon/landscape_evolution
r.sim.terrain --ui
```

---

## RULSE evolution model
Create a new mapset called `rusle` with the module
[g.mapset](https://grass.osgeo.org/grass74/manuals/g.mapset.html).
```
g.mapset -c mapset=rusle location=nc_spm_evolution
```

Set your region to the study area with 1 meter resolution
using the module
[g.region](https://grass.osgeo.org/grass74/manuals/g.region.html).
Optionally set the watershed as a mask using the module
[r.mask](https://grass.osgeo.org/grass74/manuals/r.mask.html).
Copy `elevation_2016` from the `PERMANENT` mapset to the current mapset
using the module
[g.copy](https://grass.osgeo.org/grass74/manuals/g.copy.html).
```
g.region region=region res=1
r.mask vector=watershed
g.copy raster=elevation_2016@PERMANENT,elevation_2016
```

Run *r.sim.terrain* with the RUSLE model
for a 120 min event with a rainfall intensity of 50 mm/hr
at a 3 minute interval.
The interval should be set to the time it takes a
particle of water to cross the region.
Set the empirical coefficients m and n
for the upslope contributing area and the slope can range
from 0.2 to 0.6 and 1.0 to 1.3 respectively
with low values representing dominant sheet flow
and high values representing dominant rill flow.
Optionally use the `-f` flag to fill depressions
in order to reduce the effect of positive feedback loops.
This simulation may take approximately 2 minutes to run.
```
r.sim.terrain -f elevation=elevation_2016 runs=event mode=rusle_mode \
rain_intensity=50.0 rain_duration=120 rain_interval=3 m=0.4 n=1.3
```

To simulate landscape evolution using RUSLE with
spatially variable landcover and soil erodibility factors
use `c_factor` and `k_factor` raster maps.
Rerun the model with the `--overwrite` flag.
```
r.sim.terrain -f elevation=elevation_2016 runs=event mode=rusle_mode \
rain_intensity=50.0 rain_duration=120 rain_interval=3 m=0.4 n=1.3 \
c_factor=c_factor k_factor=k_factor fluxmax=0.25 grav_diffusion=0.05 --overwrite
```

Display the results with the raster map `net_difference` and a raster legend.
```
d.rast map=net_difference
d.legend raster=net_difference range=-2,0
```

<p align="center">
  <img src="images/tutorial/rusle_difference_1m.png" height="360">
  <img src="images/tutorial/rusle_variable_difference_1m.png" height="360">
</p>
Net differences (m) for dynamic RUSLE simulations with
**(a)** constant versus **(b)** spatially variable
landcover and soil erodibility factors.
Both were simulated for a 120 min event
with a rainfall intensity of 50 mm/hr
at 3 minute interval at 1 meter resolution.

---

## USPED evolution model
Create a new mapset called `usped` with the module
[g.mapset](https://grass.osgeo.org/grass74/manuals/g.mapset.html).
```
g.mapset -c mapset=usped location=nc_spm_evolution
```

Set your region to the study area with 1 meter resolution
using the module
[g.region](https://grass.osgeo.org/grass74/manuals/g.region.html).
Optionally set the watershed as a mask using the module
[r.mask](https://grass.osgeo.org/grass74/manuals/r.mask.html).
Copy `elevation_2016` from the `PERMANENT` mapset to the current mapset
using the module
[g.copy](https://grass.osgeo.org/grass74/manuals/g.copy.html).
```
g.region region=region res=1
r.mask vector=watershed
g.copy raster=elevation_2016@PERMANENT,elevation_2016
```

Run *r.sim.terrain* with the USPED model
for a 120 min event with a rainfall intensity of 50 mm/hr
at a 3 minute interval.
Set the empirical coefficients m and n
for the upslope contributing area and the slope to
1.5 and 1.2 respectively.
Optionally use the `-f` flag to fill depressions
in order to reduce the effect of positive feedback loops.
This simulation may take approximately 3 minutes to run.
```
r.sim.terrain -f elevation=elevation_2016 runs=event mode=usped_mode \
rain_intensity=50.0 rain_duration=120 rain_interval=3 m=1.5 n=1.2
```

To simulate landscape evolution using RUSLE with
spatially variable landcover and soil erodibility factors
use `c_factor` and `k_factor` raster maps.
Rerun the model with the `--overwrite` flag.
```
r.sim.terrain -f elevation=elevation_2016 runs=event mode=usped_mode \
rain_intensity=50.0 rain_duration=120 rain_interval=3 m=1.5 n=1.2 \
c_factor=c_factor k_factor=k_factor erdepmin=-0.25 erdepmax=0.25 \
density_value=1.6 grav_diffusion=0.05 --overwrite
```

Display the results with the raster map `net_difference` and a raster legend.
```
d.rast map=net_difference
d.legend raster=net_difference range=-2,2
```

<p align="center">
  <img src="images/tutorial/usped_difference_1m.png" height="360">
  <img src="images/tutorial/usped_variable_difference_1m.png" height="360">
</p>
Net differences (m) for dynamic USPED simulations with
**(a)** constant versus **(b)** spatially variable
landcover and soil erodibility factors.
Both were simulated for a 120 min event
with a rainfall intensity of 50 mm/hr
at 3 minute interval at 1 meter resolution.

---

## SIMWE evolution model


### Erosion-deposition regime
Create a new mapset called `erdep` with the module
[g.mapset](https://grass.osgeo.org/grass74/manuals/g.mapset.html).
```
g.mapset -c mapset=erdep location=nc_spm_evolution
```

Set your region to the study area with 1 meter resolution
using the module
[g.region](https://grass.osgeo.org/grass74/manuals/g.region.html).
Optionally set the watershed as a mask using the module
[r.mask](https://grass.osgeo.org/grass74/manuals/r.mask.html).
Copy `elevation_2016` from the `PERMANENT` mapset to the current mapset
using the module
[g.copy](https://grass.osgeo.org/grass74/manuals/g.copy.html).
```
g.region region=region res=1
r.mask vector=watershed
g.copy raster=elevation_2016@PERMANENT,elevation_2016
```

Run *r.sim.terrain* with the SIMWE model
for a 120 min event with a rainfall intensity of 50 mm/hr.
Optionally use the `-f` flag to fill depressions
in order to reduce the effect of positive feedback loops.
```
r.sim.terrain -f  elevation=elevation_2016@erdep runs=event mode=simwe_mode \
rain_intensity=50.0 rain_interval=120 rain_duration=10 walkers=1000000 \
manning=mannings runoff=runoff
```

---

### Detachment limited regime
Create a new mapset called `flux` with the module
[g.mapset](https://grass.osgeo.org/grass74/manuals/g.mapset.html).
```
g.mapset -c mapset=flux location=nc_spm_evolution
```

*Under development...*

---

### Transport limited regime
Create a new mapset called `transport` with the module
[g.mapset](https://grass.osgeo.org/grass74/manuals/g.mapset.html).
```
g.mapset -c mapset=transport location=nc_spm_evolution
```

Set your region to the study area with 0.3 meter resolution
using the module
[g.region](https://grass.osgeo.org/grass74/manuals/g.region.html).
Optionally set the watershed as a mask using the module
[r.mask](https://grass.osgeo.org/grass74/manuals/r.mask.html).
```
g.region region=region res=0.3
r.mask vector=watershed
```

Run *r.sim.terrain* with the SIMWE model
for a 120 min event with a rainfall intensity of 50 mm/hr.
Use a transport value lower than the detachment value
to trigger a transport limited erosion regime.
Optionally use the `-f` flag to fill depressions
in order to reduce the effect of positive feedback loops.
```
r.sim.terrain -f elevation=elevation_2016@erdep runs=event mode=simwe_mode \
rain_intensity=50.0 rain_interval=120 rain_duration=10 walkers=1000000 \
detachment_value=0.01 transport_value=0.0001 manning=mannings runoff=runoff
```

<p align="center">
  <img src="images/ss_transport_3d/legend_erosion_deposition.png" height="150">
  <img src="images/ss_transport_3d/erosion_deposition.png" height="360">
  <img src="images/ss_transport_3d/legend_difference.png" height="150">
  <img src="images/ss_transport_3d/difference.png" height="360">
</p>
Erosion-deposition (kg*m/s^2)and net difference (m)
for a steady state, transport limited SIMWE simulation
of a 120 min event with a rainfall intensity of 50 mm/hr

<p align="center">
  <img src="images/sample_data/elevation_2016.png" height="360">
  <img src="images/ss_transport/shaded_relief.png" height="360">
</p>
Elevation from 2016 airborne lidar survey
and elevation after a steady state, transport limited SIMWE simulation
of a 120 min event with a rainfall intensity of 50 mm/hr

## Parallel processing
*Under development...*

## Travel time
*Under development...*

## Animation
*Under development...*
